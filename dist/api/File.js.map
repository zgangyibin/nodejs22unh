{"version":3,"sources":["../../src/api/File.js"],"names":["config","db","api","storage","multer","diskStorage","destination","req","file","cb","path","join","__dirname","filename","parse","originalname","name","Date","now","extname","upload","post","any","res","toRes","files","err","session","get","download","query","fileName"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;;;kBAEe,gBAAoB;AAAA,KAAjBA,MAAiB,QAAjBA,MAAiB;AAAA,KAATC,EAAS,QAATA,EAAS;;AAClC,KAAIC,MAAM,sBAAV;AACA;AACA,KAAIC,UAAUC,iBAAOC,WAAP,CAAmB;AAChC;AACAC,eAAa,qBAAUC,GAAV,EAAeC,IAAf,EAAqBC,EAArB,EAAyB;AACrCA,MAAG,IAAH,EAASC,eAAKC,IAAL,CAAUC,SAAV,EAAqB,iBAArB,CAAT,EADqC,CACY;AACjD,GAJ+B;AAKhCC,YAAU,kBAAUN,GAAV,EAAeC,IAAf,EAAqBC,EAArB,EAAyB;AAClCA,MAAG,IAAH,EAASC,eAAKI,KAAL,CAAWN,KAAKO,YAAhB,EAA8BC,IAA9B,GAAqC,GAArC,GAA2CC,KAAKC,GAAL,EAA3C,GAAwDR,eAAKS,OAAL,CAAaX,KAAKO,YAAlB,CAAjE;AACA;AACA;AAR+B,EAAnB,CAAd;AAUA;AACA,KAAIK,SAAS,sBAAO,EAAEjB,gBAAF,EAAP,CAAb;;AAEA;AACAD,KAAImB,IAAJ,CAAS,SAAT,EAAoBD,OAAOE,GAAP,EAApB,EAAkC,UAACf,GAAD,EAAMgB,GAAN,EAAc;;AAE/C,MAAI;AACHC,mBAAMhB,IAAN,CAAWe,GAAX,EAAgB,CAAhB,EAAmBhB,IAAIkB,KAAJ,CAAU,CAAV,EAAaZ,QAAhC;AACA,GAFD,CAEE,OAAMa,GAAN,EAAW;AACZF,mBAAMG,OAAN,CAAcJ,GAAd,EAAmB,GAAnB,EAAwB,QAAxB,EAAkC,EAAlC,EAAsC,GAAtC;AACA;AACD,EAPD;;AASA;AACArB,KAAI0B,GAAJ,CAAQ,WAAR,EAAqB,UAACrB,GAAD,EAAMgB,GAAN,EAAc;;AAElC,MAAI;AACHA,OAAIM,QAAJ,CAAanB,eAAKC,IAAL,CAAUC,SAAV,EAAqB,qBAAqBL,IAAIuB,KAAJ,CAAUC,QAApD,CAAb;AACA,GAFD,CAEE,OAAML,GAAN,EAAW;AACZF,mBAAMG,OAAN,CAAcJ,GAAd,EAAmB,GAAnB,EAAwB,QAAxB,EAAkC,EAAlC,EAAsC,GAAtC;AACA;AACD,EAPD;;AASA,QAAOrB,GAAP;AACA,C","file":"File.js","sourcesContent":["import { Router } from 'express'\nimport toRes from '../lib/toRes'\nimport multer from 'multer'\nimport path  from 'path'\n\nexport default ({ config, db }) => {\n\tlet api = Router()\n\t//设置文件存储路径\n\tlet storage = multer.diskStorage({\n\t\t//上传文件的物理路径\n\t\tdestination: function (req, file, cb) {\n\t\t\tcb(null, path.join(__dirname, '../views/upload'))//上传的相对路径\n\t\t},\n\t\tfilename: function (req, file, cb) {\n\t\t\tcb(null, path.parse(file.originalname).name + '-' + Date.now() + path.extname(file.originalname))\n\t\t\t//originalname是上传图片的本名\n\t\t}\n\t})\n\t// 添加配置文件到multer对象，身上有一个single方法，接收字符串为前端传来的表单字段名称，会自动解析这个字段下的内容\n\tlet upload = multer({ storage })\n\n\t// 文件上传接口\n\tapi.post('/upload', upload.any(), (req, res) => {\n\n\t\ttry {\n\t\t\ttoRes.file(res, 0, req.files[0].filename)\n\t\t} catch(err) {\n\t\t\ttoRes.session(res, 500, '服务器错误！', '', 500)\n\t\t}\n\t})\n\n\t// 文件下载接口\n\tapi.get('/download', (req, res) => {\n\n\t\ttry {\n\t\t\tres.download(path.join(__dirname, '../views/upload/' + req.query.fileName))\n\t\t} catch(err) {\n\t\t\ttoRes.session(res, 500, '服务器错误！', '', 500)\n\t\t}\n\t})\n\n\treturn api\n}\n"]}